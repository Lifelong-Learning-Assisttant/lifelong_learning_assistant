@startuml quiz-generation-sequence
!theme plain
title Генерация квиза (sync + async)

participant "Пользователь" as U
participant "Web UI" as UI
participant "API Gateway" as API
participant "Orchestrator" as AG
participant "Retriever" as RET
participant "LLM Service" as LLM
participant "PostgreSQL" as DB
participant "Task Queue" as MQ
participant "Worker" as Worker

U -> UI: "Сгенерируй 10 вопросов по главе X"
UI -> API: POST /api/quiz/create
API -> AG: create_quiz_request

AG -> RET: retrieve(chapter X)
RET --> AG: fragments
AG -> LLM: generate_quiz(prompt+fragments)
LLM --> AG: quiz_payload

AG -> DB: save(quiz_metadata)
AG -> MQ: enqueue(persist_quiz_assets)

API --> UI: 202 {task_id, quiz_id}

note over MQ,Worker: Асинхронная обработка
MQ -> Worker: process_assets
Worker -> Worker: attach_media, precompute_hints
Worker -> DB: update_quiz_status(ready)

@enduml