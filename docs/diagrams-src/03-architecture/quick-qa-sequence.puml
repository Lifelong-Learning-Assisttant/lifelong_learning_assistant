@startuml quick-qa-sequence
!theme plain
title Быстрый Q&A с provenance

participant "Пользователь" as U
participant "Web UI" as UI
participant "API Gateway" as API
participant "Orchestrator" as AG
participant "Retriever" as RET
participant "Vector DB" as VDB
participant "Elasticsearch" as ES
participant "LLM Service" as LLM
participant "Внешние источники" as EXT

U -> UI: Задает вопрос
UI -> API: POST /api/ask {question}
API -> AG: Запрос

AG -> RET: retrieve(context)

par Векторный поиск
    RET -> VDB: semantic_search(query)
    VDB --> RET: similar_chunks
else Полнотекстовый поиск
    RET -> ES: fulltext_search(query)
    ES --> RET: exact_matches
end

RET --> AG: fragments + metadata

opt При необходимости внешний контекст
    AG -> EXT: Tavily/Context7 поиск
    EXT --> AG: web_sources
end

AG -> LLM: prompt + context
LLM --> AG: answer

AG --> API: ответ + provenance
API --> UI: результат с источниками
UI --> U: Отображение ответа с цитированием

@enduml